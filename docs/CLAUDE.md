# CLAUDE.md - 開発メモ

このドキュメントは、Claudeとの会話で決定した技術的な事項やTODOを記録します。

## 技術的決定事項

### パッケージマネージャー
- **選択**: npm（pnpm → npmに変更）
- **理由**: Vercelビルド環境でpnpmの`ERR_INVALID_THIS`エラーが解決できなかった
- **日付**: 2025-11-25

### AIプロバイダー対応
- **実装**: Anthropic Direct + OpenRouter
- **切り替え**: 環境変数 `AI_PROVIDER` で制御
- **モデル選択**: Settings画面で選択可能
- **日付**: 2025-11-26

### レンダリング戦略
- **データベース接続ページ**: 動的レンダリング (`force-dynamic`)
- **理由**: ビルド時にDATABASE_URL不要にするため
- **日付**: 2025-11-25

## TODO

### Phase 1: モデル選択機能 ✅ (完了 2025-11-26)
- [x] Prismaスキーマに`provider`と`model`フィールド追加
- [x] Zustandストアで設定管理
- [x] Settings画面でモデル選択UI
- [x] 分析時に選択モデルを使用
- [x] 分析結果にモデル名を表示

### Phase 2: モデル比較・フィルタリング機能 (未実装)

#### モデルごとの分析結果フィルタリング
- [ ] 分析履歴ページにモデルフィルター追加
- [ ] プロバイダー・モデル別の集計表示
- [ ] 特定モデルでの分析結果のみ表示

#### 分析結果評価機能
- [ ] Prismaスキーマに`userRating`フィールド追加（1-5星）
- [ ] 分析結果に評価ボタン追加
- [ ] ユーザーコメント機能（オプション）

#### モデル統計・比較画面
- [ ] `/models` ページ作成
- [ ] モデルごとの使用回数集計
- [ ] モデルごとの平均評価表示
- [ ] 評価分布グラフ（Recharts使用）
- [ ] 最も評価が高いモデルのハイライト

### Phase 3: 高度な分析・蓄積機能 (未実装)

#### 夢パターン分析とモデル精度
- [ ] 夢のカテゴリ別モデル精度分析
  - 例: 悪夢、予知夢、明晰夢など
- [ ] シンボル検出精度の比較
- [ ] テーマ抽出精度の比較

#### モデル推奨機能
- [ ] ユーザーの評価履歴から最適モデルを推奨
- [ ] 夢のタイプに応じた推奨モデル表示

#### データエクスポート
- [ ] モデル比較レポートのPDFエクスポート
- [ ] 分析データのCSVエクスポート

### その他の機能改善

#### 認証
- [ ] NextAuth.js v5 実装
- [ ] ユーザー登録・ログイン
- [ ] ソーシャルログイン（Google, GitHub）

#### データ管理
- [ ] 夢の編集・削除機能
- [ ] 夢のエクスポート（JSON, PDF）
- [ ] データバックアップ機能

#### UI/UX
- [ ] PWA対応（オフライン機能）
- [ ] 夢の検索機能
- [ ] タグ管理機能
- [ ] ダークモード対応

#### モバイルアプリ
- [ ] Expoプロジェクトセットアップ
- [ ] 共有コンポーネントの実装
- [ ] プッシュ通知（就寝リマインダー）

## 既知の問題

### Vercel Postgres制限
- **問題**: Hobbyプランの無料枠が小さい（256MB）
- **推奨**: Neon Postgres（512MB無料）への移行を検討

### セキュリティ
- [ ] npm audit で1 critical severity vulnerability
  - 対応検討中

## パフォーマンス

### ビルド時間
- Vercel: 約1分30秒

### 最適化候補
- [ ] 画像最適化（next/image使用）
- [ ] バンドルサイズ削減
- [ ] コード分割

## メモ

### モデル選択機能について
ユーザーが異なるAIモデルを試して比較できるようにすることで：
1. どのモデルが夢分析に適しているかを検証できる
2. ユーザー自身のデータで精度を蓄積できる
3. 将来的にはコミュニティで最適モデルを共有できる可能性

Phase 1で基本機能を実装済み。Phase 2以降は段階的に実装予定。
