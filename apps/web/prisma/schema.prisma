generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?

  dreams    Dream[]
  dreamers  Dreamer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Dreamer {
  id           String  @id @default(cuid())
  userId       String
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  name         String  // 名前（例: 自分、妻、妻の母）
  relationship String? // 関係性（例: 本人、配偶者、義母）
  notes        String? @db.Text // メモ

  dreams       Dream[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, name]) // 同じユーザー内で同じ名前は不可
  @@index([userId])
}

model Dream {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  dreamerId String
  dreamer   Dreamer @relation(fields: [dreamerId], references: [id], onDelete: Cascade)

  title   String
  content String @db.Text
  date    DateTime

  // 夢の属性
  mood               DreamMood
  lucidity           Int       @default(5)
  vividness          Int       @default(5)
  emotionalIntensity Int       @default(5)

  // 環境・状況
  setting    String?
  characters String[]
  emotions   String[]
  colors     String[]

  // メタデータ
  sleepQuality Int?
  bedTime      DateTime?
  wakeTime     DateTime?
  tags         String[]

  // 分析
  analyzed  Boolean        @default(false)
  analyses  DreamAnalysis[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([dreamerId, date])
  @@index([date])
}

enum DreamMood {
  JOYFUL
  PEACEFUL
  ANXIOUS
  FEARFUL
  SAD
  ANGRY
  CONFUSED
  EXCITED
  NEUTRAL
}

model DreamAnalysis {
  id      String @id @default(cuid())
  dreamId String
  dream   Dream  @relation(fields: [dreamId], references: [id], onDelete: Cascade)

  psychologicalInterpretation String @db.Text

  symbols              Json   // DreamSymbol[]
  themes               String[]
  emotionalAnalysis    Json
  underlyingMeanings   String[]
  insights             String[]

  relatedDreams String[]

  // AI Model Information
  provider String @default("anthropic")  // 'anthropic' or 'openrouter'
  model    String @default("claude-sonnet-4-20250514")

  analyzedAt DateTime @default(now())

  // 対話履歴
  conversations AnalysisConversation[]

  @@unique([dreamId, provider, model]) // 同じ夢を同じモデルで重複分析しない
  @@index([dreamId])
  @@index([provider])
  @@index([model])
}

// 分析結果に対する対話履歴
model AnalysisConversation {
  id         String @id @default(cuid())
  analysisId String
  analysis   DreamAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  role       String  // 'user' or 'assistant'
  content    String  @db.Text

  createdAt  DateTime @default(now())

  @@index([analysisId])
}
